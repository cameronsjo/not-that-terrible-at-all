# TOTP Approval Gate

Secure Docker image updates with phone-based TOTP approval.

## How It Works

```
┌─────────────────────────────────────────────────────────────────┐
│  1. Polls GHCR for new image digests                            │
│  2. New image found → Sends notification (optional)             │
│  3. You open approval URL → Enter 6-digit TOTP code             │
│  4. Code verified → Pulls image, restarts container             │
└─────────────────────────────────────────────────────────────────┘
```

**Security:** Even if your GitHub account is fully compromised, an attacker can't deploy malicious code because they don't have your phone with the TOTP secret.

## Quick Start

### 1. Run Setup

```bash
cd /mnt/user/appdata/approval-gate
docker-compose run --rm gate python setup.py
```

This generates a TOTP secret and QR code.

### 2. Add to 1Password (or any authenticator)

Scan the QR code. The TOTP secret is now in your password manager.

### 3. Configure

Edit `config/.env`:

```bash
# Notification method: ntfy, telegram, pushover, discord, or none
NOTIFY_METHOD=none

# Your Tailscale/accessible URL for approval links
GATE_URL=http://unraid.tailnet.ts.net:9999
```

### 4. Add Images to Monitor

Create `config/images.json`:

```json
[
  {
    "image": "ghcr.io/yourorg/yourapp:latest",
    "container": "yourapp"
  }
]
```

### 5. Start

```bash
docker-compose up -d
```

## Notification Methods

| Method | Setup | Notes |
|--------|-------|-------|
| **none** | Nothing | Just bookmark `/pending` and check after you push |
| **ntfy** | Free, self-hostable | No account needed, works great |
| **telegram** | Free bot | Easy setup |
| **pushover** | Paid ($5 one-time) | Polished, reliable |
| **discord** | Free webhook | Good if you already use Discord |

### No Notifications (Simplest)

```bash
NOTIFY_METHOD=none
```

Workflow: Push code → open `http://unraid:9999/pending` → approve.

### Ntfy (Recommended)

Free, open source, self-hostable. No account needed for public topics.

```bash
NOTIFY_METHOD=ntfy
NTFY_URL=https://ntfy.sh          # Or your self-hosted instance
NTFY_TOPIC=my-secret-topic-name   # Pick something random/private
NTFY_TOKEN=                       # Optional, for auth
```

Install the Ntfy app on your phone, subscribe to your topic.

### Telegram

1. Create a bot: message @BotFather, use `/newbot`
2. Get your chat ID: message @userinfobot
3. Configure:

```bash
NOTIFY_METHOD=telegram
TELEGRAM_BOT_TOKEN=123456:ABC-DEF...
TELEGRAM_CHAT_ID=your-chat-id
```

### Pushover

1. Create account at https://pushover.net
2. Create an application
3. Configure:

```bash
NOTIFY_METHOD=pushover
PUSHOVER_TOKEN=your-app-token
PUSHOVER_USER=your-user-key
```

### Discord

1. Server Settings → Integrations → Webhooks → New Webhook
2. Copy webhook URL
3. Configure:

```bash
NOTIFY_METHOD=discord
DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/...
```

## Configuration Reference

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `TOTP_SECRET` | Yes | - | Generated by setup script |
| `NOTIFY_METHOD` | No | `none` | `ntfy`, `telegram`, `pushover`, `discord`, `none` |
| `GATE_URL` | Yes | - | External URL for approval links |
| `GITHUB_ORG` | No | - | Your GitHub org/username |
| `GHCR_TOKEN` | No | - | Token for private images |
| `POLL_INTERVAL` | No | `300` | Seconds between checks |
| `APPROVAL_TIMEOUT` | No | `3600` | Seconds before pending approvals expire |

## API Endpoints

| Endpoint | Description |
|----------|-------------|
| `GET /` | Status and config info |
| `GET /pending` | List pending updates with approve URLs |
| `GET /approve/<token>` | Approval page |
| `POST /approve/<token>` | Submit TOTP code |

## Store TOTP in 1Password

Yes, 1Password supports TOTP natively:

1. Create/edit an item
2. Add field → One-Time Password
3. Scan the QR code from setup

1Password will generate codes and can autofill them.

## Troubleshooting

### Not receiving notifications

1. Check `NOTIFY_METHOD` is set correctly
2. Check logs: `docker-compose logs -f`
3. Verify credentials for your notification method

### TOTP codes not working

1. Check your phone's time is synced
2. Codes are valid for ±30 seconds
3. Make sure you're using the right TOTP entry

### Can't access approval page

1. Check `GATE_URL` matches how you access Unraid
2. Ensure port 9999 is accessible
3. Check container is running: `docker-compose ps`
