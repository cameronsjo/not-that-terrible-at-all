# TOTP Approval Gate

Secure Docker image updates with phone-based TOTP approval.

## How It Works

```
┌─────────────────────────────────────────────────────────────────┐
│  1. Polls GHCR for new image digests                            │
│  2. New image found → Sends Pushover notification               │
│  3. You tap link → Enter 6-digit TOTP code                      │
│  4. Code verified → Pulls image, restarts container             │
└─────────────────────────────────────────────────────────────────┘
```

**Why this is secure:**

Even if your GitHub account is fully compromised, an attacker can't deploy malicious code because they don't have your phone with the authenticator app.

## Quick Start

### 1. Run Setup

```bash
cd /mnt/user/appdata/approval-gate
docker-compose run --rm gate python setup.py
```

This will:
- Generate a TOTP secret
- Display a QR code to scan with your authenticator app
- Create `config/.env` template

### 2. Scan QR Code

Add to your authenticator app (Google Authenticator, Authy, 1Password, etc.)

### 3. Configure

Edit `config/.env`:

```bash
# Required: Pushover credentials
PUSHOVER_TOKEN=your-app-token
PUSHOVER_USER=your-user-key

# Required: Your Tailscale/accessible URL
GATE_URL=http://unraid.tailnet.ts.net:9999

# Optional: For private GHCR images
GHCR_TOKEN=ghp_xxxx
```

### 4. Add Images to Monitor

Create `config/images.json`:

```json
[
  {
    "image": "ghcr.io/yourorg/yourapp:latest",
    "container": "yourapp"
  }
]
```

### 5. Start

```bash
docker-compose up -d
```

## Configuration

| Variable | Required | Description |
|----------|----------|-------------|
| `TOTP_SECRET` | Yes | Generated by setup script |
| `PUSHOVER_TOKEN` | Yes | Pushover application token |
| `PUSHOVER_USER` | Yes | Pushover user key |
| `GATE_URL` | Yes | External URL for approval links |
| `GITHUB_ORG` | No | Your GitHub org/username |
| `GHCR_TOKEN` | No | Token for private images |
| `POLL_INTERVAL` | No | Seconds between checks (default: 300) |
| `APPROVAL_TIMEOUT` | No | Seconds before pending approvals expire (default: 3600) |

## Getting Pushover Credentials

1. Create account at https://pushover.net
2. Create an application: https://pushover.net/apps/build
3. Copy the API Token → `PUSHOVER_TOKEN`
4. Copy your User Key → `PUSHOVER_USER`

## API Endpoints

| Endpoint | Description |
|----------|-------------|
| `GET /` | Status and pending update count |
| `GET /pending` | List pending updates |
| `GET /approve/<token>` | Approval page |
| `POST /approve/<token>` | Submit TOTP code |

## Troubleshooting

### Not receiving notifications

1. Check Pushover credentials in `.env`
2. Check logs: `docker-compose logs -f`
3. Verify images.json is valid JSON

### TOTP codes not working

1. Check your phone's time is synced
2. Codes are valid for ±30 seconds
3. Re-run setup if needed

### Can't pull images

1. Check GHCR_TOKEN has `read:packages` scope
2. Verify docker socket is mounted
3. Check container has network access
